<!DOCTYPE html>
<html>
  <head>
    <title>CrimeLoc</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="stylesheets/css/foundation.css">
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
    <script src="semantic/dist/semantic.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <!-- <link rel="stylesheet" href="/resources/demos/style.css"> -->
    <script src="jquery.timepicker.min.js"></script>
    <link rel="stylesheet" href="jquery.timepicker.css">

  </head>

  <body>

    <div class="ui multiple selection dropdown" style="visibility: hidden">
      <!-- This will receive comma separated value like OH,TX,WY !-->
      <input id="buildings" name="buildings" type="hidden">
      <i class="dropdown icon"></i>
      <div class="default text">Building</div>
      <div class="menu">
        <div data-value="Academic/Administrative">Academic/Administrative</div>
        <div data-value="Administrative">Administrative</div>
        <div data-value="Athletics">Athletics</div>
        <div data-value="Dining">Dining</div>
        <div data-value="Housing">Housing</div>
        <div data-value="Library">Library</div>
        <div data-value="Medical">Medical</div>
        <div data-value="Parking">Parking</div>
        <div data-value="Performance">Performance</div>
        <div data-value="Store">Store</div>
      </div>

      <input id="crimes" name="crimes" type="hidden">
      <i class="dropdown icon"></i>
      <div class="default text">Crimes</div>
      <div class="menu">
        <div data-value="Arson">Arson</div>
        <div data-value="Injury to personal property">Injury to personal property</div>
        <div data-value="Weapon Possession">Weapon Possession</div>

      </div>
    </div>



    <div class="row" align = "center">
      <h1>Welcome to CrimeLoc!</h1>
    </div>
    <div class="row" align="center">
      <div class="large-12 columns">
      <label>Search Parameters (specify as many or as few as desired)
      </label>
        <br><br>
      </div>
    </div>
      <div class="large-3 columns">
        <a id="clear">Clear</a>
        <select name="buildings" class="ui selection dropdown" multiple="" id="multi-select">
          <option value="">Building Types</option>
          <option value="Academic/Administrative">Academic/Administrative</option>
          <option value="Athletics">Athletic</option>
          <option value="Dining">Dining</option>
          <option value="Housing">Housing</option>
          <option value="Library">Library</option>
          <option value="Medical">Medical</option>
          <option value="Parking">Parking</option>
          <option value="Performance">Performance</option>
          <option value="Store">Store</option>
        </select>
      </div>
      <div class="large-3 columns">
        <a id="clear1">Clear</a>
         <select name="crimes" class="ui selection dropdown" multiple="" id="multi-select2">
          <option value="">Crime Types</option>
           <option value="Arson">Arson</option>
           <option value="Injury to personal property">Injury to personal property</option>
           <option value="Weapon Possession">Weapon Possession</option>
        </select>
      </div>
      <div class="large-2 columns" align="center">
        <label> Date
          <br>
          <label> From
            <input id="datepicker1" type="text"></input>
          </label>
          <label> To
            <input id="datepicker2" type="text"></input>
          </label>
        </label>
        <a id="clear3">Clear</a>
      </div>
      <div class="large-2 columns" align="center">
        <label> Time
          <br>
          <label>From
            <input id="time1" class="ui-timepicker-input" type="text"></input>
          </label>
          <br>
          <label>To
            <input id="time2" class="ui-timepicker-input" type="text"></input>
          </label>
        </label>
        <a id="clear4">Clear</a>
      </div>
      <div class="large-2 columns">
        <label>Campus
          <form id="campus">
            <input value="West" type="checkbox" name="campus" id="west"><label for="west">West</label>
            </input>
            <input value="East" type="checkbox" name="campus" id="east"><label for="east">East</label>
            </input>
            <input value="Central" type="checkbox" name="campus" id="central"><label for="central">Central</label>
            </input>
          </form>
        </label>
        <a id="clear2">Clear</a>
      </div>
    <div class="row" align="center">
      <div class="large-12 columns">
        <br>
        <button id="update_map">Show crimes</button>
      </div>
    </div>
    <br>
    </div>

    <div class="row" align="center" id="gmap" style="width: 600px; height: 400px;">
    </div>
    <div id="controls"></div>

    <br>    <br>    <br>    <br>    <br>\

  </body>

  <link rel="stylesheet" href="pqselect.dev.css" />
  <script src = "pqselect.dev.js"></script>


  <script>
    $('#datepicker1').datepicker();
    $('#datepicker2').datepicker();
  </script>

  <script>
    $('#time1').timepicker();
    </script>

    <script>
      $('#time2').timepicker();
      </script>

  <script>
  $('#multi-select')
.dropdown()
;
  </script>

  <script>
    $('#multi-select').dropdown();
    $('#multi-select2').dropdown();
  </script>

  <script>
  $('document').ready(function () {

    //load and initialize map
    var map;
    $(function() {
        map = new Maplace({
      locations: [{
         lat: 36.0011,
         lon: -78.9391,
         zoom: 14
     }],
    controls_type: 'list',
    controls_title: 'Choose a location:'
        }).Load();
    });

    //functions to clear drop down lists
    $('#clear').click(function() {
      $('#multi-select').dropdown('clear');
    });
    $('#clear1').click(function() {
      $('#multi-select2').dropdown('clear');
    });

    $('#clear3').click(function() {
      document.getElementById("datepicker1").value = "";
      document.getElementById("datepicker2").value = "";
    });

    $('#clear4').click(function() {
      document.getElementById("time1").value = "";
      document.getElementById("time2").value = "";
    });
    //action taken when "show crimes" button pressed
    $("#update_map").click(function() {

      var building = $('#multi-select').dropdown('get value');
      var crime = $('#multi-select2').dropdown('get value');
      building.splice(building.length-1, 1);
      crime.splice(crime.length-1, 1);

      var d1 = document.getElementById("datepicker1").value.split('/');
      if(d1.length === 1){
        date1 = "";
      } else {
        var date1 = d1[2] + "-" + d1[0] + "-" + d1[1];
      }

      var d2 = document.getElementById("datepicker2").value.split('/');
      if(d2.length === 1){
        date2 = "";
      } else {
        var date2 = d2[2] + "-" + d2[0] + "-" + d2[1];
      }
      var time1 = document.getElementById("time1").value;
      var time2 = document.getElementById("time2").value;
      var campus = [];
      $('#campus input:checked').each(function() {
        campus.push($(this).attr('value'));
      });
      var t1 = '';
      var t2 = '';
      if(time1 != ""){
        t1 = time1.split(":")[0];
        if(time1.indexOf('pm') != -1 && t1 !== '12'){
          t1 = parseInt(t1) + 12;
        } else if(time1.indexOf('am') != -1 && t1 === '12'){
          t1 = 0;
        }
        if(parseInt(t1) < 10){
          t1 = "0" + t1;
        }
        t1 = t1 + ":" + time1.split(":")[1].split("am")[0].split("pm")[0];
      }
      if(time2 != ""){
        t2 = time2.split(":")[0];
        if(time2.indexOf('pm') != -1 && t2 !== '12'){
          t2 = parseInt(t2) + 12;
        } else if(time2.indexOf('am') != -1 && t2 === '12'){
          t2 = 0;
        }
        if(parseInt(t2) < 10){
          t2 = "0" + t2;
        }
        t2 = t2 + ":" + time2.split(":")[1].split("am")[0].split("pm")[0];
      }
      if(t1 != "" && t2 != "" && (parseInt(t1.split(":")[0]) > parseInt(t2.split(":")[0]) || (parseInt(t1.split(":")[0]) === parseInt(t2.split(":")[0]) && parseInt(t1.split(":")[1]) > parseInt(t2.split(":")[1])))){
        // console.log(t1, t2);
        window.alert("Enter a valid time range, please (the start time must be less than the end time)");
      } else if(date1 != "" && date2 != "" && date1 >= date2){
        // console.log(date1, date2);
        window.alert("Enter a valid date range, please (the start date must be less than the end date)");
      } else{
        var query_params = '?building=' + JSON.stringify(building) + '&crime=' + JSON.stringify(crime) + '&date1=' + date1 + '&date2=' + date2 + '&time1=' + t1 + '&time2=' + t2 + '&campus=' + JSON.stringify(campus);
        //Make ajax call here
        $.ajax({
          url: "./query" + query_params,
          type: "GET"
        }).done(function(data){
            if(data.error){
              console.log(data.error);
            } else{
              // console.log(JSON.stringify(data));
              console.log(JSON.stringify(data[0]));
              //assume array of info for crimes is returned as data here
              while(map.markers.length > 0){
                map.RemoveLocations(0, true);
              }

              //loop through crimes list and add a marker for each
              for(i=0; i<data.length; i++){
                var temp = data[i];
                var stuff = temp.crime + ", " + temp.loc.building + ", " + temp.loc.campus + " campus";

                map.AddLocations([{lat: temp.lat,
                  lon: temp.lon, title: stuff, location: temp.loc,
                    html: '<p>' + stuff + '</p>',}], i, false);
              }

              //TODO: make the map properly scaled after adding markers
              map.Load();
            }
          });

      }
    });




    //action taken to clear campus specification
    $("#clear2").click(function() {
      document.getElementById("west").checked=false;
      document.getElementById("east").checked=false;
      document.getElementById("central").checked=false;
    });




  });
  </script>

  <script src="//maps.google.com/maps/api/js?sensor=false&amp;libraries=geometry&amp;v=3.7"></script>
  <script src="maplace-0.1.3.js"></script>
  </head>

  </html>
